const key_info_list = [
    {
        key_code: "KeyQ",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "q",
        ascii_text_shift: "Q",
        ru_text: "й",
        ru_text_shift: "Й",
    },
    {
        key_code: "KeyW",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "w",
        ascii_text_shift: "W",
        ru_text: "ц",
        ru_text_shift: "Ц",
    },
    {
        key_code: "KeyE",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "e",
        ascii_text_shift: "E",
        ru_text: "у",
        ru_text_shift: "У",
    },
    {
        key_code: "KeyR",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "r",
        ascii_text_shift: "R",
        ru_text: "к",
        ru_text_shift: "К",
    },
    {
        key_code: "KeyT",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "t",
        ascii_text_shift: "T",
        ru_text: "е",
        ru_text_shift: "Е",
    },
    {
        key_code: "KeyY",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "y",
        ascii_text_shift: "Y",
        ru_text: "н",
        ru_text_shift: "Н",
    },
    {
        key_code: "KeyU",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "u",
        ascii_text_shift: "U",
        ru_text: "г",
        ru_text_shift: "Г",
    },
    {
        key_code: "KeyI",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "i",
        ascii_text_shift: "I",
        ru_text: "ш",
        ru_text_shift: "Ш",
    },
    {
        key_code: "KeyO",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "o",
        ascii_text_shift: "O",
        ru_text: "щ",
        ru_text_shift: "Щ",
    },
    {
        key_code: "KeyP",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "p",
        ascii_text_shift: "P",
        ru_text: "з",
        ru_text_shift: "З",
    },
    {
        key_code: "KeyA",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "a",
        ascii_text_shift: "A",
        ru_text: "ф",
        ru_text_shift: "Ф",
    },
    {
        key_code: "KeyS",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "s",
        ascii_text_shift: "S",
        ru_text: "ы",
        ru_text_shift: "Ы",
    },
    {
        key_code: "KeyD",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "d",
        ascii_text_shift: "D",
        ru_text: "в",
        ru_text_shift: "В",
    },
    {
        key_code: "KeyF",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "f",
        ascii_text_shift: "F",
        ru_text: "а",
        ru_text_shift: "А",
    },
    {
        key_code: "KeyG",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "g",
        ascii_text_shift: "G",
        ru_text: "п",
        ru_text_shift: "П",
    },
    {
        key_code: "KeyH",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "h",
        ascii_text_shift: "H",
        ru_text: "р",
        ru_text_shift: "Р",
    },
    {
        key_code: "KeyJ",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "j",
        ascii_text_shift: "J",
        ru_text: "о",
        ru_text_shift: "О",
    },
    {
        key_code: "KeyK",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "k",
        ascii_text_shift: "K",
        ru_text: "л",
        ru_text_shift: "Л",
    },
    {
        key_code: "KeyL",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "l",
        ascii_text_shift: "L",
        ru_text: "д",
        ru_text_shift: "Д",
    },
    {
        key_code: "KeyZ",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "z",
        ascii_text_shift: "Z",
        ru_text: "я",
        ru_text_shift: "Я",
    },
    {
        key_code: "KeyX",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "x",
        ascii_text_shift: "X",
        ru_text: "ч",
        ru_text_shift: "Ч",
    },
    {
        key_code: "KeyC",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "c",
        ascii_text_shift: "C",
        ru_text: "с",
        ru_text_shift: "С",
    },
    {
        key_code: "KeyV",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "v",
        ascii_text_shift: "V",
        ru_text: "м",
        ru_text_shift: "М",
    },
    {
        key_code: "KeyB",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "b",
        ascii_text_shift: "B",
        ru_text: "и",
        ru_text_shift: "И",
    },
    {
        key_code: "KeyN",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "n",
        ascii_text_shift: "N",
        ru_text: "т",
        ru_text_shift: "Т",
    },
    {
        key_code: "KeyM",
        is_ascii_letter: true,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "m",
        ascii_text_shift: "M",
        ru_text: "ь",
        ru_text_shift: "Ь",
    },
    {
        key_code: "Backquote",
        is_ascii_letter: false,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "\`",
        ascii_text_shift: "~",
        ru_text: "ё",
        ru_text_shift: "Ё",
    },
    {
        key_code: "BracketLeft",
        is_ascii_letter: false,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "[",
        ascii_text_shift: "{",
        ru_text: "х",
        ru_text_shift: "Х",
    },
    {
        key_code: "BracketRight",
        is_ascii_letter: false,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "]",
        ascii_text_shift: "}",
        ru_text: "ъ",
        ru_text_shift: "Ъ",
    },
    {
        key_code: "Semicolon",
        is_ascii_letter: false,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: ";",
        ascii_text_shift: ":",
        ru_text: "ж",
        ru_text_shift: "Ж",
    },
    {
        key_code: "Quote",
        is_ascii_letter: false,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: "\'",
        ascii_text_shift: "\"",
        ru_text: "э",
        ru_text_shift: "Э",
    },
    {
        key_code: "Comma",
        is_ascii_letter: false,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: ",",
        ascii_text_shift: "<",
        ru_text: "б",
        ru_text_shift: "Б",
    },
    {
        key_code: "Period",
        is_ascii_letter: false,
        is_ru_letter: true,
        is_function_key: false,
        name: "",
        ascii_text: ".",
        ascii_text_shift: ">",
        ru_text: "ю",
        ru_text_shift: "Ю",
    },
    {
        key_code: "Digit1",
        is_ascii_letter: false,
        is_ru_letter: false,
        is_function_key: false,
        name: "",
        ascii_text: "1",
        ascii_text_shift: "!",
        ru_text: "",
        ru_text_shift: "",
    },
    {
        key_code: "Digit2",
        is_ascii_letter: false,
        is_ru_letter: false,
        is_function_key: false,
        name: "",
        ascii_text: "2",
        ascii_text_shift: "@",
        ru_text: "",
        ru_text_shift: "\"",
    },
    {
        key_code: "Digit3",
        is_ascii_letter: false,
        is_ru_letter: false,
        is_function_key: false,
        name: "",
        ascii_text: "3",
        ascii_text_shift: "#",
        ru_text: "",
        ru_text_shift: "№",
    },
    {
        key_code: "Digit4",
        is_ascii_letter: false,
        is_ru_letter: false,
        is_function_key: false,
        name: "",
        ascii_text: "4",
        ascii_text_shift: "$",
        ru_text: "",
        ru_text_shift: ";",
    },
    {
        key_code: "Digit5",
        is_ascii_letter: false,
        is_ru_letter: false,
        is_function_key: false,
        name: "",
        ascii_text: "5",
        ascii_text_shift: "%",
        ru_text: "",
        ru_text_shift: "",
    },
    {
        key_code: "Digit6",
        is_ascii_letter: false,
        is_ru_letter: false,
        is_function_key: false,
        name: "",
        ascii_text: "6",
        ascii_text_shift: "^",
        ru_text: "",
        ru_text_shift: ":",
    },
    {
        key_code: "Digit7",
        is_ascii_letter: false,
        is_ru_letter: false,
        is_function_key: false,
        name: "",
        ascii_text: "7",
        ascii_text_shift: "&",
        ru_text: "",
        ru_text_shift: "?",
    },
    {
        key_code: "Digit8",
        is_ascii_letter: false,
        is_ru_letter: false,
        is_function_key: false,
        name: "",
        ascii_text: "8",
        ascii_text_shift: "*",
        ru_text: "",
        ru_text_shift: "",
    },
    {
        key_code: "Digit9",
        is_ascii_letter: false,
        is_ru_letter: false,
        is_function_key: false,
        name: "",
        ascii_text: "9",
        ascii_text_shift: "(",
        ru_text: "",
        ru_text_shift: "",
    },
    {
        key_code: "Digit0",
        is_ascii_letter: false,
        is_ru_letter: false,
        is_function_key: false,
        name: "",
        ascii_text: "0",
        ascii_text_shift: ")",
        ru_text: "",
        ru_text_shift: "",
    },
    {
        key_code: "Minus",
        is_ascii_letter: false,
        is_ru_letter: false,
        is_function_key: false,
        name: "",
        ascii_text: "-",
        ascii_text_shift: "_",
        ru_text: "",
        ru_text_shift: "",
    },
    {
        key_code: "Equal",
        is_ascii_letter: false,
        is_ru_letter: false,
        is_function_key: false,
        name: "",
        ascii_text: "=",
        ascii_text_shift: "+",
        ru_text: "",
        ru_text_shift: "",
    },
    {
        key_code: "Backslash",
        is_ascii_letter: false,
        is_ru_letter: false,
        is_function_key: false,
        name: "",
        ascii_text: "\\",
        ascii_text_shift: "|",
        ru_text: "",
        ru_text_shift: "/",
    },
    {
        key_code: "Slash",
        is_ascii_letter: false,
        is_ru_letter: false,
        is_function_key: false,
        name: "",
        ascii_text: "/",
        ascii_text_shift: "?",
        ru_text: ".",
        ru_text_shift: ",",
    },
    {
        key_code: "Tab",
        is_ascii_letter: false,
        is_ru_letter: false,
        is_function_key: true,
        name: "Tab",
        ascii_text: "",
        ascii_text_shift: "",
        ru_text: "",
        ru_text_shift: "",
    },
    {
        key_code: "CapsLock",
        is_ascii_letter: false,
        is_ru_letter: false,
        is_function_key: true,
        name: "Caps Lk",
        ascii_text: "",
        ascii_text_shift: "",
        ru_text: "",
        ru_text_shift: "",
    },
    {
        key_code: "ShiftLeft",
        is_ascii_letter: false,
        is_ru_letter: false,
        is_function_key: true,
        name: "Shift",
        ascii_text: "",
        ascii_text_shift: "",
        ru_text: "",
        ru_text_shift: "",
    },
    {
        key_code: "ShiftRight",
        is_ascii_letter: false,
        is_ru_letter: false,
        is_function_key: true,
        name: "Shift",
        ascii_text: "",
        ascii_text_shift: "",
        ru_text: "",
        ru_text_shift: "",
    },
    {
        key_code: "Backspace",
        is_ascii_letter: false,
        is_ru_letter: false,
        is_function_key: true,
        name: "Bkspc",
        ascii_text: "",
        ascii_text_shift: "",
        ru_text: "",
        ru_text_shift: "",
    },
    {
        key_code: "Enter",
        is_ascii_letter: false,
        is_ru_letter: false,
        is_function_key: true,
        name: "Enter",
        ascii_text: "",
        ascii_text_shift: "",
        ru_text: "",
        ru_text_shift: "",
    }
]

const ascii_keyboard_layout = [
    ["Backquote"],
    ["KeyQ", "KeyW", "KeyE", "KeyR", "KeyT", "KeyY", "KeyU", "KeyI", "KeyO", "KeyP", "BracketLeft", "BracketRight"],
    ["KeyA", "KeyS", "KeyD", "KeyF", "KeyG", "KeyH", "KeyJ", "KeyK", "KeyL", "Semicolon", "Quote"],
    ["KeyZ", "KeyX", "KeyC", "KeyV", "KeyB", "KeyN", "KeyM", "Comma", "Period", "Slash"]
]

const ru_keyboard_layout = [
    ["Backquote", "Digit1", "Digit2", "Digit3", "Digit4", "Digit5", "Digit6", "Digit7", "Digit8", "Digit9", "Digit0", "Minus", "Equal", "Backspace"],
    ["Tab", "KeyQ", "KeyW", "KeyE", "KeyR", "KeyT", "KeyY", "KeyU", "KeyI", "KeyO", "KeyP", "BracketLeft", "BracketRight", "Backslash"],
    ["CapsLock", "KeyA", "KeyS", "KeyD", "KeyF", "KeyG", "KeyH", "KeyJ", "KeyK", "KeyL", "Semicolon", "Quote", "Enter"],
    ["ShiftLeft", "KeyZ", "KeyX", "KeyC", "KeyV", "KeyB", "KeyN", "KeyM", "Comma", "Period", "Slash", "ShiftRight"]
]

function flatten_array(array) {
    return array.reduce((pre, cur) => {
        return pre.concat(Array.isArray(cur) ? flatten_array(cur) : cur)
    }, [])
}

const ascii_keyboard_flat = flatten_array(ascii_keyboard_layout)

const ru_keyboard_flat = flatten_array(ru_keyboard_layout)

class RULetter {
    constructor(key_code, lower, upper) {
        this.key_code = key_code
        this.lower = lower
        this.upper = upper
    }
}

const ru_keys = key_info_list.filter(key => key.is_ru_letter).map(value => new RULetter(value.key_code, value.ru_text, value.ru_text_shift))

class WrongAnswer {
    constructor(ru_letter, your_key, right_key) {
        this.ru_letter = ru_letter
        this.your_key = your_key
        this.right_key = right_key
    }
}

function setDisplayKeyText(element, key_info) {
    if (element !== null && key_info !== null) {
        if (key_info.is_ascii_letter) {
            const div1 = document.createElement("div")
            div1.innerHTML = key_info.ascii_text_shift
            element.appendChild(div1)
        } else {
            const div1 = document.createElement("div")
            const div2 = document.createElement("div")
            div1.innerHTML = key_info.ascii_text_shift
            div2.innerHTML = key_info.ascii_text
            element.appendChild(div1)
            element.appendChild(div2)
        }
    }
}

function updateCurrentKey(ascii_key) {
    const current_key = document.querySelector("#current-key>.ascii-key")
    clearChildren(current_key)

    setDisplayKeyText(current_key, ascii_key)
}

class PracticeInfo {
    constructor(total_count) {
        this.total_count = total_count
        this.remain_count = this.total_count
        this.right_count = 0
        this.wrong_count = 0
        this.begin_time = null
        this.end_time = null
        this.current_key = null
        this.wrong_answers = []
        this.sequence = getRandomList(0, this.total_count)
        this.is_finish = false
    }

    getCurrentIndex() {
        let index = this.total_count - this.remain_count
        if (index < 0) {
            index = 0
        }
        if (index >= this.total_count) {
            index = this.total_count - 1
        }
        return index
    }

    reset() {
        this.remain_count = this.total_count
        this.right_count = 0
        this.wrong_count = 0
        this.begin_time = null
        this.end_time = null
        this.current_key = null
        this.wrong_answers = []
        this.sequence = getRandomList(0, this.total_count)
        this.is_finish = false
    }

    render() {
        updatePracticeProgress(this.getCurrentIndex() + 1, this.total_count)
        updtaeRULetterDisplay(ru_keys[this.sequence[this.getCurrentIndex()]])
    }

    begin() {
        this.begin_time = new Date()
    }

    end() {
        this.end_time = new Date()
    }

    getTimeCost() {
        if (this.begin_time === null || this.end_time === null) {
            return NaN
        } else {
            return (Math.abs(this.end_time.getTime() - this.begin_time.getTime()) / 1000).toFixed(2)
        }
    }

    addWrongAnswer(wrong) {
        this.wrong_answers.push(wrong)
    }

    press(key) {
        if (key !== null) {
            this.current_key = key
        }

        updateCurrentKey(this.current_key)
    }

    answered(is_right) {
        this.remain_count -= 1
        if (this.remain_count <= 0) {
            this.remain_count = 0
            this.is_finish = true
        }
        if (is_right) {
            this.right_count += 1
        } else {
            this.wrong_count += 1
        }

    }

    getRightRate() {
        const total = this.remain_count + this.right_count + this.wrong_count
        if (total <= 0) {
            return NaN
        } else {
            return (this.right_count / total * 100).toFixed(1)
        }
    }
}

const practice_trace = new PracticeInfo(ru_keys.length)

function getKeyByCode(code) {
    let res = null
    for (let key of key_info_list) {
        if (key.key_code === code) {
            res = key
            break
        }
    }
    return res
}

function getRandomList(from, num) {
    if (num <= 0) {
        return []
    }

    const array = []
    for (let i = from; i < from + num; ++i) {
        array.push(i)
    }

    let index = -1
    let lastIndex = array.length - 1
    while (++index < array.length) {
        const rnd = index + Math.floor(Math.random() * (lastIndex - index + 1))
        const tmp = array[rnd]
        array[rnd] = array[index]
        array[index] = tmp
    }

    return array
}

function hideAllPages() {
    Array.from(document.querySelector("#main").children).forEach(page => {
        page.style.display = "none"
    })
}

function clearChildren(element) {
    while (element.hasChildNodes()) {
        element.removeChild(element.lastChild)
    }
}

function updatePracticeProgress(cur, total) {
    const practice_progress = document.querySelector("#practice-progress")
    practice_progress.querySelector("div:nth-child(1)").innerHTML = cur === -1 ? "" : (cur < 10 ? "0" : "") + cur
    practice_progress.querySelector("div:nth-child(3)").innerHTML = total === -1 ? "" : (total < 10 ? "0" : "") + total
}

function updtaeRULetterDisplay(letter) {
    if (letter === null) {
        return
    }

    const ru_letter_display = document.querySelector("#ru-letter-card>.ru-letter-display")
    ru_letter_display.querySelector("div:nth-child(1)").innerHTML = letter === null ? "" : letter.upper
    ru_letter_display.querySelector("div:nth-child(2)").innerHTML = letter === null ? "" : letter.lower
}
function updateWrongAnswers() {
    const review_list = document.querySelector("#review-list")
    clearChildren(review_list)

    for (let wrong of practice_trace.wrong_answers) {
        const review_item = document.createElement("div")
        review_item.classList.add("review-item")

        const title = document.createElement("div")
        title.classList.add("ru-letter-display")
        const title_div1 = document.createElement("div")
        title_div1.innerHTML = wrong.ru_letter.upper
        const title_div2 = document.createElement("div")
        title_div2.innerHTML = wrong.ru_letter.lower
        title.appendChild(title_div1)
        title.appendChild(title_div2)

        const review_keys = document.createElement("div")
        review_keys.classList.add("review-keys")

        const your_key = document.createElement("div")
        your_key.classList.add("your-key")
        const key_title1 = document.createElement("div")
        key_title1.classList.add("key-title")
        key_title1.innerHTML = "Yours"
        const ascii_key1 = document.createElement("div")
        ascii_key1.classList.add("ascii-key")
        setDisplayKeyText(ascii_key1, wrong.your_key)
        your_key.appendChild(key_title1)
        your_key.appendChild(ascii_key1)

        const right_key = document.createElement("div")
        right_key.classList.add("right-key")
        const key_title2 = document.createElement("div")
        key_title2.classList.add("key-title")
        key_title2.innerHTML = "Right"
        const ascii_key2 = document.createElement("div")
        ascii_key2.classList.add("ascii-key")
        setDisplayKeyText(ascii_key2, wrong.right_key)
        right_key.appendChild(key_title2)
        right_key.appendChild(ascii_key2)

        review_keys.append(your_key)
        review_keys.append(right_key)

        review_item.appendChild(title)
        review_item.appendChild(review_keys)

        review_list.appendChild(review_item)
    }
}

function disableAsciiKeyboardHighlight() {
    const ascii_keyboard_keys = document.querySelectorAll("#ascii-keyboard-main .ascii-key.ascii-key-active")
    for (let key of ascii_keyboard_keys) {
        key.classList.remove("ascii-key-active")
    }
}

function initialPracticePage() {
    const practice_page = document.querySelector("#practice-page")
    const score_panel = practice_page.querySelector("#score-panel")
    const current_key = practice_page.querySelector("#current-key>.ascii-key")

    clearChildren(score_panel)
    clearChildren(current_key)

    for (let i = 0; i < practice_trace.total_count; ++i) {
        const dot = document.createElement("div")
        dot.classList.add("score-dot")
        score_panel.appendChild(dot)
    }

    disableAsciiKeyboardHighlight()

    practice_trace.reset()
    practice_trace.render()
    practice_trace.begin()
}

function initialSummaryPage() {
    const right_rate = document.querySelector("#right-rate")
    const time_cost = document.querySelector("#time-cost")

    right_rate.querySelector("div:nth-child(1)").innerHTML = practice_trace.getRightRate().toString()
    time_cost.querySelector("div:nth-child(1)").innerHTML = practice_trace.getTimeCost().toString()

    updateWrongAnswers()
}

function finishCallback() {
    practice_trace.end()
    hideAllPages()
    document.querySelector("#summary-page").style.display = "flex"
    initialSummaryPage()
}

function activeEnterKey() {
    // console.log("enter")
    if (practice_trace.current_key !== null) {
        let ru_letter = ru_keys[practice_trace.sequence[practice_trace.getCurrentIndex()]]
        const res = ru_letter.key_code === practice_trace.current_key.key_code
        document.querySelector(`#score-panel>.score-dot:nth-child(${practice_trace.getCurrentIndex() + 1})`).classList.add(`score-dot-${res ? "right" : "wrong"}`)
        practice_trace.answered(res)
        practice_trace.render()
        if (!res) {
            practice_trace.addWrongAnswer(new WrongAnswer(ru_letter, practice_trace.current_key, getKeyByCode(ru_letter.key_code)))
        }
        practice_trace.current_key = null
        disableAsciiKeyboardHighlight()
        clearChildren(document.querySelector("#current-key>.ascii-key"))
        if (practice_trace.is_finish) {
            finishCallback()
        }
    }
}

function activeCommonKey(element) {
    const cur_key = getKeyByCode(element.getAttribute("key-code"))
    if (cur_key === null) {
        return
    }

    disableAsciiKeyboardHighlight()

    element.classList.add("ascii-key-active")
    practice_trace.press(cur_key)
}

// function finishPractice() { }

function createAsciiKeyboard() {
    const keyboard = document.querySelector("#ascii-keyboard-main")
    for (let line of ascii_keyboard_layout) {
        const keyboard_line = document.createElement("div")
        keyboard_line.classList.add("keyboard-line")
        for (let code of line) {
            const key = getKeyByCode(code)
            if (key !== null) {
                const ascii_key = document.createElement("div")
                ascii_key.classList.add("ascii-key")
                ascii_key.setAttribute("key-code", key.key_code)
                if (key.is_ascii_letter) {
                    const div1 = document.createElement("div")
                    div1.innerHTML = key.ascii_text_shift
                    ascii_key.appendChild(div1)
                } else {
                    const div1 = document.createElement("div")
                    const div2 = document.createElement("div")
                    div1.innerHTML = key.ascii_text_shift
                    div2.innerHTML = key.ascii_text
                    ascii_key.appendChild(div1)
                    ascii_key.appendChild(div2)
                }
                ascii_key.addEventListener("click", (event) => {
                    event.stopPropagation()
                    activeCommonKey(ascii_key)
                })
                keyboard_line.appendChild(ascii_key)
            }
        }
        keyboard.appendChild(keyboard_line)
    }
}

function createRUKeyboard() {
    const ru_keyboard = document.querySelector("#ru-keyboard-main")
    for (let line of ru_keyboard_layout) {
        const keyboard_line = document.createElement("div")
        keyboard_line.classList.add("keyboard-line")
        for (let code of line) {
            const key = getKeyByCode(code)
            if (key === null) {
                continue
            }
            const ru_key = document.createElement("div")
            ru_key.classList.add("ru-key")
            let function_key_class = ""
            if (key.is_function_key) {
                switch (key.key_code) {
                    case "Tab":
                        function_key_class = "ru-key-tab"
                        break
                    case "ShiftLeft":
                        function_key_class = "ru-key-shift"
                        break
                    case "ShiftRight":
                        function_key_class = "ru-key-shift-r"
                        break
                    case "CapsLock":
                        function_key_class = "ru-key-capslock"
                        break
                    case "Backspace":
                        function_key_class = "ru-key-backspace"
                        break
                    case "Enter":
                        function_key_class = "ru-key-enter"
                        break
                    default: break
                }
            }
            if (function_key_class !== "") {
                ru_key.classList.add(function_key_class)
            }

            const ru_key_l = document.createElement("div")
            ru_key_l.classList.add("ru-key-l")

            const ru_key_r = document.createElement("div")
            ru_key_r.classList.add("ru-key-r")

            const div11 = document.createElement("div")
            div11.innerHTML = key.is_function_key ? key.name : key.ascii_text_shift

            const div12 = document.createElement("div")
            div12.innerHTML = key.is_ascii_letter ? "" : key.ascii_text

            const div21 = document.createElement("div")
            div21.innerHTML = key.is_ru_letter ? "" : key.ru_text_shift

            const div22 = document.createElement("div")
            div22.innerHTML = key.is_ru_letter ? key.ru_text_shift : key.ru_text

            ru_key_l.appendChild(div11)
            ru_key_l.appendChild(div12)
            ru_key_r.appendChild(div21)
            ru_key_r.appendChild(div22)

            ru_key.appendChild(ru_key_l)
            ru_key.appendChild(ru_key_r)

            keyboard_line.appendChild(ru_key)
        }
        ru_keyboard.appendChild(keyboard_line)
    }
}

document.addEventListener("DOMContentLoaded", () => {
    const start_button = document.querySelector("#start-button")
    const finish_button = document.querySelector("#finish-button")
    const again_button = document.querySelector("#again-button")
    const back_button = document.querySelector("#back-button")
    const show_button = document.querySelector("#show-ru-keyboard-button")
    const close_button = document.querySelector("#close-ru-keyboard-button")
    const enter_key = document.querySelector("#ascii-keyboard-enter>div")

    createAsciiKeyboard()
    createRUKeyboard()

    start_button.addEventListener("click", () => {
        hideAllPages()
        document.querySelector("#practice-page").style.display = "flex"
        initialPracticePage()
    })

    finish_button.addEventListener("click", () => {
        finishCallback()
    })

    again_button.addEventListener("click", () => {
        hideAllPages()
        document.querySelector("#practice-page").style.display = "flex"
        initialPracticePage()
    })

    back_button.addEventListener("click", () => {
        hideAllPages()
        document.querySelector("#start-page").style.display = "flex"
    })

    show_button.addEventListener("click", () => {
        const modal = document.querySelector("#ru-keyboard-modal")
        modal.style.display = "flex"
    })

    close_button.addEventListener("click", () => {
        const modal = document.querySelector("#ru-keyboard-modal")
        modal.style.display = "none"
    })

    enter_key.addEventListener("click", (event) => {
        activeEnterKey()
    })

    window.addEventListener("keydown", (event) => {
        event.stopPropagation()
        // console.log(event.code)
        if (document.querySelector("#practice-page").style.display !== "none") {
            if (event.key === "Enter") {
                activeEnterKey()
                return
            }

            const cur_key = document.querySelector(`#ascii-keyboard .ascii-key[key-code=\"${event.code}\"]`)
            if (cur_key !== null) {
                activeCommonKey(cur_key)
            }
        }
    })
})
